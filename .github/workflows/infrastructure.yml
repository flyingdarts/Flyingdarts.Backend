name: "Run CDK diff"

on:
  [pull_request]

permissions:
  contents: read
  pull-requests: write

jobs:
  cdk-diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3.1.0
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{secrets.MY_GITHUB_TOKEN}}

      - name: Build and push
        id: docker_build
        uses: docker/build-push-action@v2
        with:
          context: ./
          file: ./IYLTDSU.Signalling.Infrastructure/Dockerfile
          tags: local/websocketsinfra:latest
          push: false

      - name: Run
        run: | 
          docker run -e AWS_REGION=${{ secrets.AWS_REGION }} -e AWS_ACCOUNT=${{ secrets.AWS_ACCOUNT }} -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} local/websocketsinfra:latest >> $GITHUB_STEP_SUMMARY
          echo "$GITHUB_STEP_SUMMARY"
          cat $GITHUB_STEP_SUMMARY
      - name: Write JSON to file.  
        uses: devops-actions/json-to-file@v1.0.0
        with:
          json: ${{ cat github.step_summary }}
          filename: cdk-diff.json
          
      - name: Commit file
        uses: EndBug/add-and-commit@v9.1.1
        with:
          add: 'cdk-diff.json'
          default_author: github_actions
          message: 'CDK diff result'